#!/bin/sh

#  Copyright 2004 INRIA
#  $Id: configure,v 1.34 2008-12-22 09:01:19 weis Exp $

check () {
  type "$1" >/dev/null 2>&1
}

# Default settings

DEFAULT_DEBUG=true

# General defaults for the package installation.
DEFAULT_PREFIX=/usr/local

DEFAULT_LIB_DIR="${DEFAULT_PREFIX}/lib"
DEFAULT_BIN_DIR="${DEFAULT_PREFIX}/bin"

# Defaults for Caml.
DEFAULT_CAML_BYT=ocamlc
DEFAULT_CAML_BIN=ocamlopt
DEFAULT_CAML_YAC=ocamlyacc
DEFAULT_CAML_LEX=ocamllex
DEFAULT_BYT_DEBUG_FLAGS="-g -dtypes"
DEFAULT_BIN_DEBUG_FLAGS="-dtypes"

# Defaults for Coq.
DEFAULT_USE_COQC=false
DEFAULT_COQRC="$HOME/.coqrc"
DEFAULT_COQC=coqc

# Defaults external commands
DEFAULT_SUM=sum
DEFAULT_CONVERT=convert
DEFAULT_GS=gs

set_default_sum () {
 for i in sum md5 md5sum md5deep sha1deep sha256deep; do
   if check $i; then DEFAULT_SUM=$i; break; fi
 done
}

set_default_convert () {
  if check ${DEFAULT_CONVERT}; then :;
  else DEFAULT_CONVERT=:;
  fi
}

set_default_gs () {
  if check ${DEFAULT_GS}; then :;
  else DEFAULT_GS=:;
  fi
}

set_command_defaults () {
  set_default_sum;
  set_default_convert;
  set_default_gs;
}

set_command_defaults

while : ; do
  case $# in 0) break;; esac
  case "$1" in
    -prefix | --prefix) PREFIX="$2"; shift 2;;
    -bindir | --bindir) BIN_DIR="$2"; shift 2;;
    -libdir | --libdir) LIB_DIR="$2"; shift 2;;
    -caml_byt | --caml_byt) CAML_BYT="$2"; shift 2;;
    -caml_bin | --caml_bin) CAML_BIN="$2"; shift 2;;
    -coqc | --coqc) COQC="$2"; shift 2;;
    -coqrc | --coqrc) COQRC="$2"; shift 2;;
    -use_coqc | --use_coqc) USE_COQC="$2"; shift 2;;
    -convert | --convert) CONVERT="$2"; shift 2;;
    -sum | --sum) SUM="$2"; shift 2;;
    -gs | --gs) GS="$2"; shift 2;;
    -debug | --debug | --enable-debug) DEBUG=true; shift;;
    -nodebug | --nodebug | --disable-debug) DEBUG=false; shift;;
    -help | --help)
       echo "usage: ./configure [options]"
       echo "options are:"
       echo "  [-]-bindir <directory>"
       echo "    set the binary directory for installation (default ${BIN_DIR})"
       echo "  [-]-libdir <directory>"
       echo "    set the library directory for installation (default ${LIB_DIR})"
       echo "  [-]-prefix <directory>"
       echo "    set the directory prefix for installation (default ${PREFIX})"
       echo "  [-]-caml_byt <executable-file>"
       echo "    set absolute path for the Caml byte code compiler."
       echo "  [-]-caml_bin <executable-file>"
       echo "    set absolute path for the Caml binary compiler."
       echo "  [-]-use_coqc <boolean>"
       echo "    set if coqc must be used to verify the proofs given by zenon."
       echo "  [-]-coqc <executable-file>"
       echo "    set absolute path for the command coqc."
       echo "  [-]-coqrc <file>"
       echo "    set absolute path for coqrc, the startup file for coqc."
       echo "  [-]-debug | [-]-enable-debug"
       echo "    enable debugging"
       echo "  [-]-convert <executable-file>"
       echo "    set absolute path for the command convert."
       echo "  [-]-gs <executable-file>"
       echo "    set absolute path for the command gs."
       echo "  [-]-nodebug | --disable-debug"
       echo "    disable debugging"
       echo "  [-]-sum <executable-file>"
       echo "    set absolute path for the check-sum command."
       echo "  [-]-help";
       echo "    display help and exit"
       exit 0
       ;;
    *) echo "./configure: bad option '$1'" >&2
       echo "For help, use ./configure -help" >&2
       exit 2
       ;;
  esac
done

if $DEBUG; then
  BYT_DEBUG_FLAGS=${DEFAULT_BYT_DEBUG_FLAGS}
  BIN_DEBUG_FLAGS=${DEFAULT_BIN_DEBUG_FLAGS}
else
  BYT_DEBUG_FLAGS=
  BIN_DEBUG_FLAGS=
fi

set_external_tools () {
  if test -z $PREFIX; then PREFIX="${DEFAULT_PREFIX}"; fi
  if test -z $LIB_DIR; then LIB_DIR="${DEFAULT_LIB_DIR}"; fi
  if test -z $BIN_DIR; then BIN_DIR="${DEFAULT_BIN_DIR}"; fi
  if test -z $CAML_BYT; then CAML_BYT="${DEFAULT_CAML_BYT}"; fi
  if test -z $CAML_BIN; then CAML_BIN="${DEFAULT_CAML_BIN}"; fi
  if test -z $CAML_LEX; then CAML_LEX="${DEFAULT_CAML_LEX}"; fi
  if test -z $CAML_YAC; then CAML_YAC="${DEFAULT_CAML_YAC}"; fi
  if test -z $COQC; then COQC="${DEFAULT_COQC}"; fi
  if test -z $COQRC; then COQRC="${DEFAULT_COQRC}"; fi
  if test -z $USE_COQC; then USE_COQC="${DEFAULT_USE_COQC}"; fi
  if test -z $SUM; then SUM="${DEFAULT_SUM}"; else
    if check $SUM; then :; else echo "Configure: unavailable command $SUM."; exit 2; fi
  fi
  if test -z $CONVERT; then CONVERT="$DEFAULT_CONVERT"; else
    if check $CONVERT; then :; else echo "Configure: unavailable command $CONVERT."; exit 2; fi
  fi
  if test -z $GS; then GS="$DEFAULT_GS"; else
    if check $GS; then :; else echo "Configure: unavailable command $GS."; exit 2; fi
  fi
}

set_external_tools

sed -e "s,@PREFIX@,$PREFIX," \
    -e "s,@BIN_DIR@,$BIN_DIR," \
    -e "s,@LIB_DIR@,$LIB_DIR," \
    -e "s,@CAML_BYT@,$CAML_BYT," \
    -e "s,@CAML_BIN@,$CAML_BIN," \
    -e "s,@CAML_LEX@,$CAML_LEX," \
    -e "s,@CAML_YAC@,$CAML_YAC," \
    -e "s,@BYT_DEBUG_FLAGS@,$BYT_DEBUG_FLAGS," \
    -e "s,@BIN_DEBUG_FLAGS@,$BIN_DEBUG_FLAGS," \
    -e "s,@COQC@,$COQC," \
    -e "s,@COQRC@,$COQRC," \
    -e "s,@USE_COQC@,$USE_COQC," \
    -e "s,@SUM@,$SUM," \
    -e "s,@CONVERT@,$CONVERT," \
    -e "s,@GS@,$GS," \
    <.config_var.in >.config_var

echo
echo "Configuration summary for zenon:"
echo
cat .config_var
